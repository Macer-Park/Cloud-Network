
<!DOCTYPE html>


<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
	<title>NAT</title>
	 
	<meta http-equiv="Cache-Control" content="no-cache">



	<script async src="//cmp.optad360.io/items/c428e370-bd30-496f-a2e4-02cab3167834.min.js"></script>
	<script async src="//get.optad360.io/sf/75cae880-234e-40f6-bef5-26ed7be31f46/plugin.min.js"></script>


	
	<meta name="naver-site-verification" content="be151cf4b4a63ec06ea92a3294c1fcd853e6c945" />

	
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
 	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" CONTENT="컴퓨터 네트워크에서 NAT는 IP 패킷 헤더의 IP 주소를 변경하는 일련의 프로세스다.인터넷은 공개망(public network)로 모든 정보가 공개되는 것을 원칙으로 한다.. &#34;모든게 공개된다!!&#34; 멋진 말이긴 하지만 외부로 공개하기 껄끄러운 정보도 있기 마련이다. 예컨데, 기업에서 만들어지는 정보의 상당수는 외부로의 공개를 금지한다. private망은 private망 구성용으로 남겨둔 ip 주소영역을 사용합니다. 각 클래스 별로 private 망 구성용 주소를 남겨두고 있다. Private 망을 위한 IP는 에 정의돼 있다. ">
	<meta name="og:description" content="컴퓨터 네트워크에서 NAT는 IP 패킷 헤더의 IP 주소를 변경하는 일련의 프로세스다.인터넷은 공개망(public network)로 모든 정보가 공개되는 것을 원칙으로 한다.. &#34;모든게 공개된다!!&#34; 멋진 말이긴 하지만 외부로 공개하기 껄끄러운 정보도 있기 마련이다. 예컨데, 기업에서 만들어지는 정보의 상당수는 외부로의 공개를 금지한다. private망은 private망 구성용으로 남겨둔 ip 주소영역을 사용합니다. 각 클래스 별로 private 망 구성용 주소를 남겨두고 있다. Private 망을 위한 IP는 에 정의돼 있다. " />
	<meta property='og:description' content="컴퓨터 네트워크에서 NAT는 IP 패킷 헤더의 IP 주소를 변경하는 일련의 프로세스다.인터넷은 공개망(public network)로 모든 정보가 공개되는 것을 원칙으로 한다.. &#34;모든게 공개된다!!&#34; 멋진 말이긴 하지만 외부로 공개하기 껄끄러운 정보도 있기 마련이다. 예컨데, 기업에서 만들어지는 정보의 상당수는 외부로의 공개를 금지한다. private망은 private망 구성용으로 남겨둔 ip 주소영역을 사용합니다. 각 클래스 별로 private 망 구성용 주소를 남겨두고 있다. Private 망을 위한 IP는 에 정의돼 있다. ">
	<meta name="google-site-verification" content="x_3_02sxiKKDpTo7b1K5qtTpt39BXF_BhZ3oYUO9qdg" />
	<meta property="fb:app_id" content="892313440881489" />
	<meta property="og:image" content="https://www.joinc.co.kr/theme/joinc/img/main_cover_about.png">
	<meta data-n-head="ssr" data-hid="image" property="og:image" content="https://joinc-edu.s3.ap-northeast-2.amazonaws.com/joinc-posting/cover_joinc.jpg">
	<meta data-n-head="ssr" data-hid="twitter" name="twitter:image" content="https://joinc-edu.s3.ap-northeast-2.amazonaws.com/joinc-posting/cover_joinc.jpg">

	
	<meta name="og:title" content="NAT" />
	<meta name="og:url" content="https://www.joinc.co.kr/w/Site/System_management/NAT" />
	<meta name="twitter:card" content="summary" />

	
	<link rel="shortcut icon" type="image/png" href="https://joinc-edu.s3.ap-northeast-2.amazonaws.com/joinc-posting/joinc_favicon.jpg">

	
	

 	

	
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Poppins:400,700&amp;display=swap" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

	
	<link rel="stylesheet" href="/theme/joinc/css/default.css">

	
	<link rel="stylesheet" href="/theme/joinc/assets/css/all.min.css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<link rel="stylesheet" href="/theme/joinc/assets/css/owl.carousel.css">
	<link rel="stylesheet" href="/theme/joinc/assets/css/magnific-popup.css">
	<link rel="stylesheet" href="/theme/joinc/assets/css/animate.css">
	<link rel="stylesheet" href="/theme/joinc/assets/css/meanmenu.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/fontawesome.min.css">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />



	<link rel="stylesheet" href="/theme/joinc/assets/css/responsive.css">
	<script src="/theme/joinc/assets/js/jquery-1.11.3.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	
	<script src="/theme/joinc/assets/js/jquery.countdown.js"></script>
	<script src="/theme/joinc/assets/js/jquery.isotope-3.0.6.min.js"></script>
	<script src="/theme/joinc/assets/js/waypoints.js"></script>
	<script src="/theme/joinc/assets/js/owl.carousel.min.js"></script>
	<script src="/theme/joinc/assets/js/jquery.magnific-popup.min.js"></script>
	<script src="/theme/joinc/assets/js/jquery.meanmenu.min.js"></script>
	<script src="/theme/joinc/assets/js/sticker.js"></script>
	<script src="/theme/joinc/assets/js/main.js?ver=12"></script>
	<link id="bootstrap-css" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<link rel="stylesheet" href="/theme/joinc/assets/css/main.css?ver=13">

	
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css"/>
	<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" />
  	<link rel="stylesheet" href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.min.css" />
    <link rel="stylesheet" href="https://uicdn.toast.com/editor-plugin-color-syntax/latest/toastui-editor-plugin-color-syntax.min.css" />
	

	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />


	
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/3.0.1/vue-router.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
	<script>Vue.options.delimiters = ['<%', '%>']</script>
	<style type="text/css" media="screen">

	</style>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-ME6WD62HQF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ME6WD62HQF');
</script>
	<link rel="stylesheet" href="/theme/joinc/assets/css/joinc.css?ver=2">
</head>

<body>


<script src="https://uicdn.toast.com/tui-color-picker/latest/tui-color-picker.min.js"></script>

<script src="/theme/joinc/assets/js/toastui-editor-all.min.js"></script>

<script src="https://uicdn.toast.com/editor-plugin-color-syntax/latest/toastui-editor-plugin-color-syntax.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/theme/joinc/assets/js/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
<script src="https://uicdn.toast.com/editor-plugin-uml/latest/toastui-editor-plugin-uml.min.js"></script>





	<div id="sticker" class="top-header-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-12 col-sm-12 text-center">
					<div class="main-menu-wrap">
						
						<div class="site-logo"><a href="/w/FrontPage"><img src="/theme/joinc/img/logo_joinc.png"
									alt="" class="logo-img"></a></div>
						
						<nav class="main-menu">
							<ul>
								<li class="current-list-item"><a href="/w/FrontPage"> </a></li>
								<li><a href="/w/education" style="color: #03fff7">Education*</a></li>
								<li><a href="/w/devops">Devops</a></li>
								<li><a href="/w/architecture">Architecture</a></li>
								<li><a href="/w/FrontBackend">F/B End</a></li>
								<li><a href="/w/blockChain">B.Chain</a></li>
								<li><a href="/w/fundamental">Basic</a></li>
								<li><a href="/w/blog">Others</a></li>
								
								
								<li>
									<div class="header-icons">
										   
									</div>
								</li>
								
								<li>
										<div class="header-icons">
											
											<a href="/w/user/signin" class="mobile-hide "><i class="fas fa-sign-in-alt"></i></a>
											
											<a href="#" class="mobile-hide search-bar-icon"><i class="fas fa-search"></i></a>
										</div>
								</li>
							</ul>
						</nav>
						<a href="#" class="mobile-show search-bar-icon"><i class="fas fa-search"></i></a>
						<div class="mobile-menu"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="search-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<span class="close-btn" style="font-size: 18px;">
						<i class="fas fa-window-close">CLOSE</i>
					</span>
					<div class="search-bar">
						<div class="search-bar-tablecell">
							<h3>Search For:</h3>
							<input type="text" placeholder="keywords" class="keyword_input">
							<button type="submit" class="keyword_button">
								Search <i class="fas fa-search"></i>
							</button>
						</br>
						</br>
						</br>
						<h3><span style="color:#fff">BY TAGS</span></h3>
				<a href="/w/taglist?name=linux" type="button" class="btn btn-primary btn-outline">linux</a>
				<a href="/w/taglist?name=HTTP"  type="button" class="btn btn-primary btn-outline">HTTP</a>
				<a href="/w/taglist?name=golang" class="btn btn-primary btn-outline">golang</a>
				<a href="/w/taglist?name=flutter" class="btn btn-primary btn-outline">flutter</a>
				<a href="/w/taglist?name=java" class="btn btn-primary btn-outline">java</a>
				<a href="/w/taglist?name=fintech" class="btn btn-primary btn-outline">fintech</a>
				<a href="/w/taglist?name=개발환경" class="btn btn-primary btn-outline">개발환경</a>
				<a href="/w/taglist?name=kubernetes" class="btn btn-primary btn-outline">kubernetes</a>
				<a href="/w/taglist?name=network" class="btn btn-primary btn-outline">network</a>
				<a href="/w/taglist?name=Docker" class="btn btn-primary btn-outline">Docker</a>
				<a href="/w/taglist?name=devops" class="btn btn-primary btn-outline">devops</a>
				<a href="/w/taglist?name=database" class="btn btn-primary btn-outline">database</a>
				<a href="/w/taglist?name=tutorial" class="btn btn-primary btn-outline">tutorial</a>
				<a href="/w/taglist?name=cli" class="btn btn-primary btn-outline">cli</a>
				<a href="/w/taglist?name=분산시스템" class="btn btn-primary btn-outline">분산시스템</a>
				<a href="/w/taglist?name=www" class="btn btn-primary btn-outline">www</a>
				<a href="/w/taglist?name=블록체인" class="btn btn-primary btn-outline">블록체인</a>
				<a href="/w/taglist?name=AWS" class="btn btn-primary btn-outline">AWS</a>
				<a href="/w/taglist?name=system admin" class="btn btn-primary btn-outline">system admin</a>
				<a href="/w/taglist?name=bigdata" class="btn btn-primary btn-outline">bigdata</a>
				<a href="/w/taglist?name=보안" class="btn btn-primary btn-outline">보안</a>
				<a href="/w/taglist?name=금융" class="btn btn-primary btn-outline">금융</a>
				<a href="/w/taglist?name=msa" class="btn btn-primary btn-outline">msa</a>
				<a href="/w/taglist?name=mysql" class="btn btn-primary btn-outline">mysql</a>
				<a href="/w/taglist?name=redis" class="btn btn-primary btn-outline">redis</a>
				<a href="/w/taglist?name=Linux command" class="btn btn-primary btn-outline">Linux command</a>
				
				<a href="/w/taglist?name=dns" class="btn btn-primary btn-outline">dns</a>
				<a href="/w/taglist?name=javascript" class="btn btn-primary btn-outline">javascript</a>
				<a href="/w/taglist?name=CICD" class="btn btn-primary btn-outline">CICD</a>
				<a href="/w/taglist?name=vpc" class="btn btn-primary btn-outline">VPC</a>
				<a href="/w/taglist?name=filesystem" class="btn btn-primary btn-outline">FILESYSTEM</A>
				<a href="/w/taglist?name=S3" class="btn btn-primary btn-outline">S3</a>
				<a href="/w/taglist?name=nginx" class="btn btn-primary btn-outline">NGINX</a>
				<a href="/w/taglist?name=tcp/ip" class="btn btn-primary btn-outline">TCP/IP</a>
				<a href="/w/taglist?name=zookeeper" class="btn btn-primary btn-outline">ZOOKEEPER</a>
				<a href="/w/taglist?name=nosql" class="btn btn-primary btn-outline">NOSQL</a>
				<a href="/w/taglist?name=iac" class="btn btn-primary btn-outline">IAC</a>
				<a href="/w/taglist?name=cloud" class="btn btn-primary btn-outline">CLOUD</a>
				<a href="/w/taglist?name=terraform" class="btn btn-primary btn-outline">TERRAFORM</a>
				<a href="/w/taglist?name=logging" class="btn btn-primary btn-outline">logging</a>
				<a href="/w/taglist?name=IT용어" class="btn btn-primary btn-outline">IT용어</a>
				<a href="/w/taglist?name=Kafka" class="btn btn-primary btn-outline">Kafka</a>
				<a href="/w/taglist?name=docker-compose" class="btn btn-primary btn-outline">docker-compose</a>
				<a href="/w/taglist?name=Dart" class="btn btn-primary btn-outline">Dart</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		$(".keyword_button").on("click", function() {
			var keyword = $(".keyword_input").val()
			window.location = "/w/search?q=" + keyword
		});
		$(".keyword_input").keyup(function(e){
			if (e.keyCode == 13) {
				var keyword = $(".keyword_input").val()
				window.location = "/w/search?q=" + keyword
			}
		});
	</script>





	<div class="breadcrumb-section sub5-hero-bg">
		<div class="container">
			<div class="row">
				<div class="col-lg-8 offset-lg-2 text-center">
					<div class="breadcrumb-text">
						<h1>NAT</h1>
					</div>
				</div>
			</div>
		</div>
	</div>


<p>

	
	<div id="comments" class="container">

	

	



<section id="comments" class="content-item"><div class="row"><div class="col-lg-8"><div class="pb-80" id="Recommanded">
	&nbsp;Recommanded <strong>Free</strong> YOUTUBE Lecture: <b><a v-bind:href="selectedImage[0]">&lt;% selectedImage[1] %></a></b>
    <ul class="list-inline media-detail pull-left">
        <li><a href="/w/user/profile?user=15"><i class="fa fa-user"></i>yundream</a></li>
        <li><i class="fa fa-calendar"></i>2018-07-14</li>
        <li><i class="fa fa-calendar"></i>2016-01-16</li>
        <li><i class="fa fa-eye"></i>154729</li>
        <li><i class="fas fa-share"></i>
            <a href="http://twitter.com/share?text=NAT&url=https%3a%2f%2fwww.joinc.co.kr%2fdoc%2f1496"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"
                target="_blank" title="Share on Twitter">
                <i class="fa fa-twitter" style="color:#428bca;"></i>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.joinc.co.kr%2fdoc%2f1496&t=NAT"
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');return false;"
                target="_blank" title="Share on Facebook">
                <i class="fa fa-facebook-official" style="color:#428bca;"></i>
            </a>
        </li>
    </ul>
</div>
<script>
new Vue({
  el: "#Recommanded",
  data: {
    images: [
      ['https://www.joinc.co.kr/w/ha-app-on-aws-cloud', 'High Avalibility Application On AWS Cloud'],
      ['https://www.joinc.co.kr/w/launching-landing-page-bootstrap-nodejs','Launching Landing Page By Bootstrap and Node JS'],
      ['https://www.joinc.co.kr/w/dockering-with-springboot-helloworld','Dockerizing with Spring Boot Hello World'],
      ['https://www.joinc.co.kr/w/Learning-and-Hacking-VPC','Learning and Hacking VPC']
    ],
    selectedImage: null
  },
  methods: {
    randomItem (items) {
      return items[Math.floor(Math.random()*items.length)]
    }
  },
  created() {
    this.selectedImage = this.randomItem(this.images)
  }
})
</script>
<script>
Array.prototype.myjoin = function(delim, depth) {
	var str = "";
	depth++;
	for(i = 0; (i < this.length ) && (i < depth); i++) {
		str+=String(this[i])+delim;
	}
	return str;
}

Array.prototype.fill = function(value, from) {
	for (i = from; i < this.length; i++) {
		this[i] = value;
	}
}

function StrRepeat(str, num) {
	return Array(num+1).join(str)
}
$(document).ready(function() {
	var isstart=true;
	var offset = 0;
	var depth=[0,0,0,0,0];
	var prev_depth = 0;
	var docIndex=[];
	$.each($(".head"), function(index) {
		var level = Number($(this).prop("tagName").substr(1));
		if (isstart){
			offset = -level
			isstart = false;
		}
		idx = level + offset;
		if ( idx != prev_depth) {
			if (idx > prev_depth) {
				depth.fill(0, idx);
			}
			prev_depth = idx;
		}
		depth[idx]++;
		var idxstr= depth.myjoin(".",idx);
		$(this).html("<a id='s-"+idxstr+"'></a>"+"<a href='#toc'>"+idxstr+"</a>"+$(this).text());

		var repeat = (level + offset);
		if (repeat < 0) {
			repeat = 0;
		}
		var indent = StrRepeat("&nbsp", (repeat) * 4);
		docIndex.push(indent+"<a href='#s-"+idxstr+"'><b>"+$(this).text()+"</b></a></br>");
	});
	$("#docIndex").html("<ul class='no-bullet' id='toc_body'>\n"+docIndex.join("\n")+"</ul>\n")
})
</script>
<a name='toc'></a>
<h2>Contents <i class='fas fa-folder' id='index_toc'></i></h2>
<div id="docIndex">
</div>
<script>
$("#docIndex").hide()
$("#index_toc").click(function() {
	$("#docIndex").toggle(function() {
		$("#index_toc").toggleClass("fas fa-folder fas fa-folder-open")
	})
});
</script>
<div class="row"><div class="col-lg-12 columns"><h2 class="head"> Network address translation </h2></div></div>
컴퓨터 네트워크에서 NAT는 IP 패킷 헤더의 IP 주소를 변경하는 일련의 프로세스다.
<p></p>

인터넷은 공개망(public network)로 모든 정보가 공개되는 것을 원칙으로 한다.. "모든게 공개된다!!" 멋진 말이긴 하지만 외부로 공개하기 껄끄러운 정보도 있기 마련이다. 예컨데, 기업에서 만들어지는 정보의 상당수는 외부로의 공개를 금지한다. 
<p></p>

private망은 private망 구성용으로 남겨둔 ip 주소영역을 사용합니다. 각 클래스 별로 private 망 구성용 주소를 남겨두고 있다. Private 망을 위한 IP는 <a href="https://tools.ietf.org/html/rfc1918" class="external"> RFC1918</a>에 정의돼 있다.   
<p></p>

<table><thead><tr><td align='center'> RFC1918 이름 </td><td align='center'> IP 주소 범위                  </td><td align='center'> 주소 갯수   </td><td align='center'> CIDR (subnet mask)            </td><td align='center'> host id 크기  </td></tr></tbody></thead><tbody>
<tr><td align='center'> 24-bit 블럭  </td><td align='center'> 10.0.0.0 ~ 10.255.255.255     </td><td align='center'> 16,777,216  </td><td align='center'> 10.0.0,0/8 (255.0.0.0)        </td><td align='center'> 24bits        </td></tr>
<tr><td align='center'> 20-bit 블럭  </td><td align='center'> 172.16.0.0 ~ 172.31.255.255   </td><td align='center'> 1,048,576   </td><td align='center'> 172.16.0.0/12 (255.240.0.0)   </td><td align='center'> 20bits        </td></tr>
<tr><td align='center'> 16-bit 블럭  </td><td align='center'> 192.168.0.0 ~ 192.168.255.255 </td><td align='center'> 65,536      </td><td align='center'> 192.168.0.0/16 (255.250.0.0)  </td><td align='center'> 16bits        </td></tr>
</tbody></table>

회사 개발팀이 사용할 private망을 192.168.100.0/24로 구축을 하면 인터넷에서 격리할 수 있을 거다.
<p></p>


<img src="https://docs.google.com/drawings/pub?id=1oHsIWlbW_HHZhmR8w8GhAzEoTyqH2dhQB239UMsn4_o&amp;w=722&amp;h=264">


<p></p>

개발망의 IP는 외부에서 식별 할 수 없으므로 안전하게 격리 운용할 수 있다. 하지만 문제가 있다. 외부에서 격리될 뿐만 아니라 내부에서 외부로 나갈 수 없기 때문이다. 인터넷을 사용 할 수 없게 되는 거다. 이 문제를 해결해 보자. 
<p></p>

개발망이 인터넷으로 부터 완전히 격리되지만, 인터넷으로의 접점인 게이트웨이(gateway)는 Public IP를 가지고 있다. 그렇다면, 인터넷으로 나가는 패킷의 Source IP를 게이트웨이의 Public IP 바꿔준다면, 이 패킷은 인터넷에서 수신/송신이 가능 할거다. 패킷을 받은 쪽은 Source IP를 Destination IP로 해서 응답을 보낼 건데, 이 IP는 게이트웨이의 IP이니 게이트웨이 까지 무사히 도착할 것이다. 물론 게이트웨이에서는 IP를 변환 정보를 추적하고 있다가, 이 패킷의 destination IP를 내부 아이피로 변환하는 작업을 거쳐야 할거다.    
<p></p>

<b>이렇게 주소를 변환해서 네트워크간 통신을 가능하게 하는 기술을 NAT(Network address translation)이라고 한다.</b>
<p></p>


<img src="https://docs.google.com/drawings/pub?id=1k7OYR51jFLaviyMYFUg3ebDU5fJsGuvpG5ZeaNs65L8&amp;w=923&amp;h=335" width=600>


<ol class="item_list">
<li>게이트웨이(이 경우 switch)에 패킷이 도착하면 source ip주소를 201.12.23.44로 바꿔서 인터넷으로 보낸다. 
</li>
<li>이 주소는 인터넷에 알려진 주소이므로 인터넷 데이터 통신이 가능하다. 
</li>
<li>switch는 NAT를 적용한 패킷의 정보를 유지한다. 그래서 NAT된 패킷이 들어오면, 이를 확인해서 수신 패킷의 destination address를 192.168.100.5로 바꾼 다음 내부망으로 보낸다.
</li></ol>
<div class="row"><div class="col-lg-12 columns"><h3 class="head"> SNAT 과 DNAT </h3></div></div>
위 예에서는 Source IP 주소를 변경했다. 이것을 SNAT(Source NAT) 혹은 <b>IP 매스커레이딩</b>이라고 한다.
<p></p>

이제 회사에 있는 개발자들은 SNAT를 이용해서 자유롭게 인터넷에서 자료를 찾을 수 있게 됐다. 그런데, 해결 해야 하는 또 다른 문제가 생겼다. 외부에서 활동하는 영업맨들을 위해서 내부에 있는 파일 서버를 외부에서 열람할 수 있도록 구성을 하라는 명령이 떨어졌다. 외부에서 내부로 들어오려면 DNAT를 사용해야 한다. DNAT은 아래에서 자세히 다루도록 하겠다. 
<p></p>

리눅스의 iptables를 이용해서 SNAT를 구성할 수 있다. SNAT를 위해서 <a href="/w/man/12/virtualbox">virtualbox</a>를 이용해서 테스트 환경을 구축했다.
<p></p>


<img src="https://docs.google.com/drawings/pub?id=1N05QRZo1mUTnHYYXCNpFjL3a9gM3M-DMDk6Opje9OO0&amp;w=687&amp;h=212" width=500>


<ul class="item_list">
<li>Linux Box : <a href="/w/man/12/virtualbox">virtualbox</a>를 실행할 리눅스 박스다. iptables를 조작해서 SNAT를 수행한다.
</li>
<li>Test VM : 테스트를 위해서 사용하는 VM이다.
</li></ul>
Linux Box의 routing 테이블이다.. 가상 인터페이스인 vboxnet0을 확인할 수 있다.. 이 인터페이스를 이용해서 test vm과 통신을 한다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250439">
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.30.1.0      0.0.0.0         255.255.255.0   U     2      0        0 wlan0
192.168.56.0    0.0.0.0         255.255.255.0   U     0      0        0 vboxnet0
0.0.0.0         172.30.1.254    0.0.0.0         UG    0      0        0 wlan0</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250439");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

인터넷으로 나가는 인터페이스는 wlan0이다.
<p></p>

Test VM의 routing 테이블 이다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250440">
# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.56.0    *               255.255.255.0   U     0      0        0 eth0
default         192.168.56.1    0.0.0.0         UG    100    0        0 eth0</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250440");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

마스커레이딩을 위해서는 FORWARD 를 Accept로 해야 한다. 아래 룰을 추가하자.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250441">
# iptables -A FORWARD -i wlan0 -j ACCEPT
# iptables -A FORWARD -o wlan0 -j ACCEPT</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250441");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

현재 Test VM에서 192.168.100.1로의 통신은 문제가 없다. 하지만 인터넷 통신이 불가능하다. 인터넷 통신이 가능하도록 Linux Box에 SNAT 설정을 했다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250442">
# iptables -t nat -A POSTROUTING -s 192.168.56.0/24 -o wlan0 -j SNAT --to 172.30.1.3</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250442");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

출발지 주소가 <b>192.168.56.0/24</b>인 패킷에 대해서 <b>nat</b>룰을 걸었다. 192.168.56.0/24에서 출발한 패킷은 리눅스 박스의 IP인 172.30.1.3으로 변경한다. 이제 이 패킷은 wlan0을 타고 바깥으로 나가게 될 거다.
<p></p>

nat룰을 적용한 후 리눅스 커널의 ip_forward를 1로 변경해 줘야 한다. 그래야지만 패킷을 외부로 내보낸다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250443">
# echo 1 &gt; /proc/sys/net/ipv4/ip_forward</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250443");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

sysctl을 이용해서 값을 변경할 수 있습니다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250444">
# sysctl -w net.ipv4.ip_forward=1</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250444");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

이 정보는 휘발성으로 부팅시 날아가 버린다. sysctl.conf에 추가해서 설정 값을 유지한다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250445">
# cat /etc/sysctl.conf
....
net.ipv4.ip_forward=1
....</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250445");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

nat룰이 잘 적용 됐는지 확인해 보자. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250446">
# iptables -t nat -L
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
SNAT       all  --  192.168.56.0/24      anywhere            to:172.30.1.3 </pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250446");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

test vm (192.168.56.101)에서 인터넷이 잘 되는지 확인했다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250447">
# ping 8.8.8.8
64 bytes from 8.8.8.8: icmp_req=1 ttl=48 time=206 ms
64 bytes from 8.8.8.8: icmp_req=2 ttl=48 time=204 ms</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250447");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

Linux Box에서 tcpdump로 icmp 패킷을 확인해봤다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250448">
# tcpdump icmp -n
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on wlan0, link-type EN10MB (Ethernet), capture size 65535 bytes
23:30:35.869225 IP 172.30.1.3 &gt; 8.8.8.8: ICMP echo request, id 1562, seq 1, length 64
23:30:36.072678 IP 8.8.8.8 &gt; 172.30.1.3: ICMP echo reply, id 1562, seq 1, length 64
23:30:36.870535 IP 172.30.1.3 &gt; 8.8.8.8: ICMP echo request, id 1562, seq 2, length 64
23:30:37.074904 IP 8.8.8.8 &gt; 172.30.1.3: ICMP echo reply, id 1562, seq 2, length 64</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250448");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

출발지와 목적지의 주소가 192.168.56.101이 아닌 172.30.1.3으로 변경된걸 확인할 수 있다. test vm(192.168.56.101)에서 icmp 패킷 확인했다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250449">
# tcpdump icmp -n
23:36:16.883660 IP 192.168.56.101 &gt; 8.8.8.8: ICMP echo request, id 1746, seq 1, length 64
23:36:17.086226 IP 8.8.8.8 &gt; 192.168.56.101: ICMP echo reply, id 1746, seq 1, length 64</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250449");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

주소가 다시 192.168.56.101로 바뀐 것을 확인할 수 있다. 
<p></p>

<div class="row"><div class="col-lg-12 columns"><h3 class="head"> Masquerade </h3></div></div>
기본적으로 masquerade와 snat는 같은일을 한다. 유일한 차이점은 snat는 변경할 source ip를 직접 명시하는데, masquerade는 명시하지 않는다는 점이다. masquerade룰을 설정할 경우 알아서 NIC의 인터넷 주소를 할당한다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250450">
# iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250450");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

<div class="row"><div class="col-lg-12 columns"><h3 class="head"> rp_filter </h3></div></div>
rp_filter는 reverse path filter 설정을 위한 커널 옵션이다. 기본 값은 1인데, 이 경우 운영체제는 패킷의 출발지 주소가 라우팅 테이블에 등록되있는지를 검사한다. 만약 등록되있지 않다면 패킷을 드롭해 버립니다. NAT 장비의 경우 네트워크 구성에 따라서 private NIC의 rp_filter 옵션을 꺼야 한다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250451">
# echo 0 &gt; /proc/sys/net/ipv4/conf/eth*/rp_filter</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250451");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

<div class="row"><div class="col-lg-12 columns"><h3 class="head"> DNAT </h3></div></div>
DNAT는 SNAT의 반대로, 목적지 IP 주소를 변경해서 내부로 접근할 수 있도록 패킷을 수정한다.
<p></p>

<div class="row"><div class="col-lg-12 columns"><h4 class="head"> DNAT를 이용한 Load balancing </h4></div></div>
DNAT의 가장 대표적인 사용용도는 서비스 Load balancing이다. 사설 네트워크인 192.168.0.2, 192.168.0.3 두 개에 웹 서비스를 구축을 했다고 가정해 보자. 우리가 원하는 것은 두 개의 내부 웹 서버로 부하를 분산하는 거다.
<p></p>

DNAT를 이용하면 패킷을 내부로 보낼 수가 있으므로, 웹 요청이 올 경우 192.168.0.2와 192.168.0.3 양쪽으로 보내도록 제어할 수 있다. DNAT 테스트를 위해서 다음과 같은 테스트 환경을 만들었습니다.
<p></p>


<img src="https://docs.google.com/drawings/pub?id=11e1SAxttPxAJLPpGw0jSpARXFsjNUv7gNiLSUUX4J0g&amp;w=641&amp;h=269" width=500>


<p></p>

Vituralbox를 이용해서 NAT 환경을 만들고, 2 개의 VM에 Apache 웹 서버를 설치했다. DNAT으로 Load balnacing를 제대로 구현한다면, HTTP 요청이 Web server 1과 2에 적당히 분배돼야 할 겁니다.
<p></p>

아래와 같이 DNAT 설정을 만들었습니다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250452">
# iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -m state \
--state NEW -m statistic --mode nth --every 2 --packet 0 -j DNAT --to 192.168.56.102
# iptables -t nat -A PREROUTING -i wlan0 -p tcp --dport 80 -m state \
--state NEW -m statistic --mode nth --every 1 --packet 0 -j DNAT --to 192.168.56.101</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250452");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

SNAT와는 달리 <b>PREROUTING</b>룰을 추가했습니다. 패킷의 IP 주소는 라우팅 되기 전에 nat 룰이 걸려야 하기 때문이다. wlan0 즉 인터넷으로 부터 들어오는 패킷 중 목적지 포트가 80인 포트에 대해서 룰을 적용했다.
<p></p>

-m 옵션을 이용해서 모듈을 로딩할 수 있다. 먼저 state 모듈을 로딩했는데, 이 모듈을 이용하면 패킷의 연결 상태에 따라서 조건을 심을 수 있다. <b>ESTABLISHED</b>, 'NEW</b>를 줄 수 있다. <b>NEW</b>는 새로 연결을 맺는 것을 의미한다.
<p></p>

다음 statistic 모듈을 로딩했다. 이 모듈은 통계에 기반해서 패킷에 조건을 주기 위해서 사용한다.  random과 nth가 있는데, nth를 사용하기로 했다. 첫번째 연결은 101, 두번째 연결은 102로 보내라 이런 의미다.
<p></p>

테스트 장비에서 172.30.1.3으로 http 요청을 보냈습니다. 패킷이 어떻게 분배됐는지 iptables로 확인했다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250453">
# iptables -t nat -L -v
Chain PREROUTING (policy ACCEPT 293 packets, 52270 bytes)
 pkts bytes target     prot opt in     out   source     destination   
    6   312 DNAT       tcp  --  wlan0  any   anywhere   anywhere     
                    tcp dpt:www state NEW statistic mode nth every 2 packet 1 to:192.168.56.102 
    3   156 DNAT       tcp  --  wlan0  any   anywhere   anywhere      
                    tcp dpt:www state NEW statistic mode nth every 2 to:192.168.56.101 </pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250453");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

<div class="row"><div class="col-lg-12 columns"><h4 class="head"> 성능 측정 </h4></div></div>
위 환경에서 iperf를 돌렸다. 성능을 측정하는게 목적이었으나, 개인 노트북에서 테스트한 거라서, 기능이 작동한다 정도만 확인할 수 있었다. 개인적으로 실제 환경에서의 성능을 측정해 보고 싶었다. 그래서 haproxy와 함께 비교 테스트를 해보기로 했다. 
<p></p>

haproxy
<ul class="item_list">
<li>테스트 대역폭 : 1GBits/sec 
</li>
<li>로드 밸런싱 웹 서버 : apache 서버 4대
</li>
<li>haproxy : 약 360 Mbits/sec 
</li>
<li>iptables DNAT : 약 750 Mbits/sec 
</li></ul>iptables가 2배 가량 성능이 좋다. CPU 점유율도 haproxy는 90%이상을 소모했는데, iptable는 대략 5%를 소비했다. 
<p></p>

<div class="row"><div class="col-lg-12 columns"><h4 class="head"> 문제 해결 및 튜닝 </h4></div></div>
<ul class="item_list">
<li>/proc/sys/net/ipv4/netfilter/ip_conntrack_count
</li></ul>    현재 추적하고 있는 연결의 갯수
<ul class="item_list">
<li>/proc/net/ip_conntrack
</li></ul>    추적중인 연결의 상세 정보를 확인할 수 있습니다. 
<ul class="item_list">
<li>/proc/sys/net/ipv4/netfilter/ip_conntrack_max 
</li></ul>    자원의 한계가 있개 때문에, 연결을 무한정 추적할 수는 없습니다. 추적가능한 연결의 최대 갯수가 정의돼 있습니다. 만약 이 최대 갯수를 추가해서 연결이 이뤄지면 패킷이 드랍됩니다. 아주 바쁜 웹 서버를 DNAT 기반으로 로드밸런싱 할 경우 ip_conntrack_max를 초과해서 패킷이 드랍될 수 있습니다. 이때는 ip_conntrack_max의 값을 변경하면 됩니다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250454">
# cat /proc/sys/net/ipv4/netfilter/ip_conntrack_max  // 현재 값
65536
# echo 131072 &gt; /proc/sys/net/ipv4/netfilter/ip_conntrack_max</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250454");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<ul class="item_list">
<li>/sys/module/nf_conntrack_ipv4/parameters/hashsize 
</li></ul>    연결 정보는 빠른 검색을 위해서 해쉬 테이블에 저장이 됩니다. 해쉬 테이블의 크기를 조정하는 것으로 성능을 튜닝할 수 있습니다. 바쁜 웹서버라면 해쉬 테이블을 크게 해서 선형 검색에 드는 시간을 줄일 수 있겠습니다. 기본 값은 16384 입니다. 만약 백만개 정도의 연결을 관리한다면, 하나의 해쉬 레코드는 1048576/16384 = 64개의 정보를 가지게 될건데, 선형 검색하기에는 지나치게 큰 수 입니다. 32768로 하면 32가 되니 좀더 효율적으로 작동할 겁니다.    
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250455">
# echo 32768 &gt; /sys/module/nf_conntrack_ipv4/parameters/hashsize</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250455");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

   해쉬 테이블을 크게 하면 메모리도 그만큼 더 소비하게 되겠죠. conntrack 하나의 크기는 228 byte이니 해쉬 테이블 크기에 따른 사용 메모리를 계산하실 수 있을 겁니다.
<p></p>

이제 tcp timeout에 대한 시간을 튜닝하면 됩니다. timeout 시간이 길면, 오랫동안 해쉬 테이블에 남아 있으니 성능이 떨어질 수 밖에 없습니다. 해쉬 테이블이 가득 차서 패킷이 드랍될 수도 있습니다. 그러니 가능한 해쉬 테이블을 빠르게 비워주는게 좋겠죠. 물론 그렇다고해서 timeout을 너무 짧게 하면 서비스에 문제가 생길 수 있으니 적당히 조절해 줘야 겠습니다.  관련 파일들은 /proc/sys/net/ipv4/netfilter/ip_conntrack_tcp_timeout_* 입니다.
<p></p>

리눅스의 기본 값은 굉장히 큽니다. 가능한 연결을 오래 보존하겠다는 얘기죠.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250456">
net.ipv4.ip_conntrack_max = 65496
net.ipv4.netfilter.ip_conntrack_generic_timeout = 600
net.ipv4.netfilter.ip_conntrack_icmp_timeout = 30
net.ipv4.netfilter.ip_conntrack_udp_timeout_stream = 180
net.ipv4.netfilter.ip_conntrack_udp_timeout = 30
net.ipv4.netfilter.ip_conntrack_tcp_timeout_close = 10
net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 120
net.ipv4.netfilter.ip_conntrack_tcp_timeout_last_ack = 30
net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait = 259200
net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait = 120
net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 432000
net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_recv = 60
net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_sent = 120
net.ipv4.netfilter.ip_conntrack_max = 65496</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250456");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

이걸 웹 서비스에 맞게 조절을 했습니다. 웹은 연결을 유지하는 서비스가 아니니 timeout을 짧게 가져가도 괜찮을 겁니다. 값은 서비스 종류와 접속량등에 따라서 달라질 수 있으니, 적당히 튜닝해서 사용하시면 되겠습니다. 
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250457">
net.ipv4.netfilter.ip_conntrack_tcp_timeout_close = 10
net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait = 20
net.ipv4.netfilter.ip_conntrack_tcp_timeout_last_ack = 20
net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait = 20
net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait = 20
net.ipv4.netfilter.ip_conntrack_tcp_timeout_established = 30
net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_recv = 20 
net.ipv4.netfilter.ip_conntrack_tcp_timeout_syn_sent = 20 </pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250457");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

<div class="row"><div class="col-lg-12 columns"><h3 class="head"> NAT 설정 저장 </h3></div></div>
Ubuntu 리눅스에서 NAT 설정을 저장하는 방법이다.
<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250458">
# iptables-save &gt; /etc/iptables.rules </pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250458");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<b>iptable-save</b>명령을 실행하면, 현재 iptables 설정정보를 표준출력 한다. 
<p></p>

<script src="/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/ace/src-noconflict/ext-language_tools.js"></script>

<div class="row">
	<div class="col-lg-12">
		<div style="border-style: solid;border-width:1px; padding:3px; border-color:#e0e0e0;">
		<pre id="textviewer1250459">
# cat /etc/network/interfaces
pre-up iptables-restore &lt; /etc/iptables.rules</pre>
		</div>
	</div>
</div>

<script>
ace.require("ace/ext/language_tools");
var textviewer = ace.edit("textviewer1250459");
textviewer.session.setMode("ace/mode/text");
textviewer.setTheme("ace/theme/tomorrow");
textviewer.setFontSize(14);
//textviewer.renderer.setShowGutter(false);
textviewer.setReadOnly(true);
textviewer.setShowPrintMargin(false);
textviewer.setHighlightActiveLine(false);
textviewer.setOptions({maxLines:30, enableBasicAutocompletion:true});
</script>

<p></p>

<div class="row"><div class="col-lg-12 columns"><h2 class="head"> stateless NAT </h2></div></div>
Stateless NAT은 dumb NAT 라고 부르기도 한다. NAT의 가장 간단한 형태로 단지 SNAT은 Source IP 주소만 변환하고, DNAT은 Destination IP반 변환해서 넘긴다. conntrack를 유지 하지 않으므로 stateful NAT 보다 빠르게 작동할 것이라고 생각된다. 반면 1:1 static NAT만 사용할 수 있다. 
<p></p>

</div>
<div class="col-lg-4">
    <div class="sidebar-section">
        <div class="recent-posts">
            <h4>Recent Posts</h4>
            <ul id="recent-post-right">
                
                <li>
                    <a href="/w/litellm_ollama">LiteLLM을 이용하여 OpenAI API로 멀티 LLM 통합</a>
                </li>
                
                <li>
                    <a href="/w/prompt-engineering">Prompt engineering</a>
                </li>
                
                <li>
                    <a href="/w/llama-3-korean">Ollama - Llama 3 한글 모델 테스트</a>
                </li>
                
                <li>
                    <a href="/w/docker-container-to-image">Docker container를 이미지 및 파일로 만들기</a>
                </li>
                
                <li>
                    <a href="/w/ollama-cromadb-rag">Llama3와 cromadb를 이용한 RAG 개념 검증</a>
                </li>
                
                <li>
                    <a href="/w/rag-test-openai">Joinc와 함께하는 LLM - LangChain & OpenAI 기반 RAG 구성</a>
                </li>
                
                <li>
                    <a href="/w/LangChain-intro">Joinc와 함께하는 LLM - LangChain을 이용한 RAG</a>
                </li>
                
                <li>
                    <a href="/w/vector_embedding_basic">Joinc와 함께하는 LLM - vector embedding 기본</a>
                </li>
                
                <li>
                    <a href="/w/ollama_setting">Joinc와 함께하는 LLM - 개인 PC에 LLM 환경 구축하기</a>
                </li>
                
                <li>
                    <a href="/w/chatting_architecture">고객 상담을 위한 Chatting 서비스 아키텍처</a>
                </li>
                
            </ul>
        </div>
        <div class="archive-posts">
            <h4>Archive Posts</h4>
            <ul id="archive-posts-right">
                
                
            </ul>
        </div>
        <div class="tag-section">

            <h4>Tags</h4>
            <ul>
                
                <li> <a href="/w/taglist?name=iptables">iptables</a> </li>
                
                <li> <a href="/w/taglist?name=network">network</a> </li>
                
                <li> <a href="/w/taglist?name=tcp/ip">tcp/ip</a> </li>
                
            </ul>
        </div>
    </div>
</div>
<script>
    $('li.li_submenu a').click(function (e) {
        $(this).closest("li").find("[class^='ul_submenu']").slideToggle();
    });
</script>
</div></section>




<style>
.like_round {
	border-radius: 20px;
	background-color: #FFFFFF;
	box-shadow: rgba(0, 0, 0, 0.3) 0px 2px 10px 0px;
	display: inline-flex;
	height: 40px;
	align-items: center;
	border-color: #000000;
	border-width: 3px;
	padding: 0px 14px 0px 16px;
	overflow: hidden;
}

@keyframes like-ani {
  from {color: black;}
  to {color: red;}
}

</style>

<div class="fixed-bottom">
	<div class="row">
	    <div class="col text-center" style="padding: 5px 10px 10px; ">
			<span class="like_round">
				<span id="like_button">
				<i class="fa fa-heart fa-lg" id="like"></i>
				</span>&nbsp;&nbsp;
				<span id="like-count" style="font-size: 14px;"></span>
			</span>
		</div>
	</div>
</div>
<script>
var count = 0
function getCount() {
	$.ajax({
		url: "/api/getLike",
		data: JSON.stringify({"pid": "1496"}),
	    contentType: "application/json",
        dataType: "json",
        type: "POST",
	}, "json").done(function(data) {
		if(data.Code != 200) {
			alert("error")
		} else {
			if (data.Node.isLike == 0) {
				$("#like").css("cursor","pointer");
				$("#like").css("color","black");
			} else {
				$("#like_button").html("<i class=\"fa fa-heart fa-lg\" id=\"like\" style=\"color: red;\"></i>");
			}
			count = data.Node.count;
			$("#like-count").html("<b>"+count+"</b>")
		}
	})
}

getCount();

$("#like").click(function(e) {
	$.ajax({
		url: "/api/addLike",
		data: JSON.stringify({"pid": "1496"}),
	    contentType: "application/json",
        dataType: "json",
        type: "POST",
	}, "json").done(function(data) {
		if(data.Code != 200) {
		} else {
			$("#like-count").html("<b>"+(count+1)+"</b>")
			$("#like").css("color","red");
			$("#like").css("cursor","default");
			$("#like").css("animation-name","like-ani");
			$("#like").css("animation-duration","3s");
		}
	})
})
</script>







</div>
</div>



	
	<div class="footer-area">
		<div class="container">
			<div class="row">
				<div class="col-lg-3 col-md-6">
					<div class="footer-box about-widget">
						<h2 class="widget-title">About</h2>
						<p>Joinc proposes educational computer-engineering contents. Especially, the contents focus on recently
							popular and meaningful topics, technically helpful for those who already work or to-be developers in the
							computer industry and theoretical or typical topics covered in undergraduate courses.</p>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div class="footer-box get-in-touch">
						<h2 class="widget-title">Get in Touch</h2>
						<ul>
							<li>joinc.help@gmail.com </li>
							
						</ul>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div class="footer-box pages">
						<h2 class="widget-title">Categories</h2>
						<ul>
							<li><a href="/w/education">Education</a></li>
							<li><a href="/w/devops">DevOps </a></li>
							<li><a href="/w/architecture">Architecture</a></li>
							<li><a href="/w/frontbackend">Front/Backend</a></li>
							<li><a href="/w/fundamental">Basic</a></li>
							<li><a href="/w/blockchain">BlockChain</a></li>
							<li><a href="/w/blog">Blog</a></li>
						</ul>
					</div>
				</div>
				<div class="col-lg-3 col-md-6">
					<div class="footer-box subscribe">
						<h2 class="widget-title">Subscribe</h2>
						<p>Subscribe to our mailing list to get the latest updates.</p>
						<form><input type="email" placeholder="joinc.help@gmail.com" readonly>
							<button type="button" onclick="location.href='mailto:joinc.help@gmail.com'"><i class="fas fa-paper-plane"></i></button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<div class="copyright">
		<div class="container">
			<div class="row">
				<div class="col-lg-6 col-md-12">
					<p>Copyrights © - <a href="#">Joinc</a>, All Rights Reserved.<br> Inherited From - <a href="#">Yundream </a>
						Rebranded By - <a href="#">Joonphil</a></p>
				</div>
				<div class="col-lg-6 text-right col-md-12">
					<div class="social-icons">
						<ul>
							<li><a href="https://www.facebook.com/joinc.edu" target="_blank"><i class="fab fa-facebook-f"></i></a></li>
							<li><a href="https://www.youtube.com/channel/UCU7xCq8nZLeDsxt4imt0jhw" target="_blank"><i class="fab fa-youtube"></i></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>

</body>
</html>
